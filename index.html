<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>英検リスニング演習 Studio (Local DB)</title>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX Compiler) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* Custom Scrollbar for better UI */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Animation utilities */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.2s ease-out;
    }

    /* Print Styles */
    @media print {
      body {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      body * {
        visibility: hidden;
      }

      #printable-area,
      #printable-area * {
        visibility: visible;
      }

      #printable-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      @page {
        size: A4;
        margin: 0mm;
      }
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // --- Icons (Inline SVG Components to avoid external dependencies) ---
    const IconWrapper = ({ children, size = 24, className = "", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
        {children}
      </svg>
    );

    const Icons = {
      Play: (p) => <IconWrapper {...p}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconWrapper>,
      Pause: (p) => <IconWrapper {...p}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconWrapper>,
      Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconWrapper>,
      Trash2: (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>,
      Volume2: (p) => <IconWrapper {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></IconWrapper>,
      PlusCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></IconWrapper>,
      CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconWrapper>,
      ChevronLeft: (p) => <IconWrapper {...p}><polyline points="15 18 9 12 15 6"></polyline></IconWrapper>,
      ChevronRight: (p) => <IconWrapper {...p}><polyline points="9 18 15 12 9 6"></polyline></IconWrapper>,
      FileText: (p) => <IconWrapper {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></IconWrapper>,
      Layers: (p) => <IconWrapper {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></IconWrapper>,
      X: (p) => <IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconWrapper>,
      Maximize2: (p) => <IconWrapper {...p}><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></IconWrapper>,
      RotateCcw: (p) => <IconWrapper {...p}><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></IconWrapper>,
      RotateCw: (p) => <IconWrapper {...p}><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></IconWrapper>,
      Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>,
      Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>,
      Gauge: (p) => <IconWrapper {...p}><path d="m12 14 4-4"></path><path d="M3.34 19a10 10 0 1 1 17.32 0"></path></IconWrapper>,
      Home: (p) => <IconWrapper {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></IconWrapper>,
      Database: (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></IconWrapper>,
      Clock: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconWrapper>,
      ArrowLeft: (p) => <IconWrapper {...p}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></IconWrapper>,
      Scissors: (p) => <IconWrapper {...p}><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></IconWrapper>,
      FolderOpen: (p) => <IconWrapper {...p}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-3.25 7a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v2"></path></IconWrapper>,
      Printer: (p) => <IconWrapper {...p}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></IconWrapper>,
      Menu: (p) => <IconWrapper {...p}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></IconWrapper>
    };

    const {
      Play, Pause, Upload, Trash2, Volume2, PlusCircle, CheckCircle,
      ChevronLeft, ChevronRight, FileText, Layers, X,
      Maximize2, RotateCcw, RotateCw, Download, Save, Gauge,
      Home, Database, Clock, ArrowLeft, Scissors, FolderOpen, Printer, Menu
    } = Icons;

    // --- Server Assets Configuration ---
    const SERVER_ASSETS = {
      json: './assets/level4/2025-2/data.json',
      projectTitle: '2025年度 第2回 英検4級 (本会場)',
      audio: [
        { name: 'Part 1 (No.1-10)', url: './assets/level4/2025-2/part1.mp3' },
        { name: 'Part 2 (No.11-20)', url: './assets/level4/2025-2/part2.mp3' },
        { name: 'Part 3 (No.21-30)', url: './assets/level4/2025-2/part3.mp3' }
      ]
    };

    // --- IndexedDB Helper Functions ---
    const DB_NAME = 'EikenStudioDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'projects';

    const initDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (e) => reject(e.target.error);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            store.createIndex('updatedAt', 'updatedAt', { unique: false });
          }
        };
      });
    };

    const saveProjectToDB = async (project) => {
      const db = await initDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put(project);
        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => reject(e.target.error);
      });
    };

    const getAllProjectsMeta = async () => {
      const db = await initDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        request.onsuccess = () => {
          const projects = request.result.map(p => ({
            id: p.id,
            title: p.title,
            updatedAt: p.updatedAt,
            pagesCount: p.pages.length,
            hasAudio: !!p.audio || (!!p.audioConfig && p.audioConfig.tracks.length > 0)
          })).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
          resolve(projects);
        };
        request.onerror = (e) => reject(e.target.error);
      });
    };

    const getProjectFromDB = async (id) => {
      const db = await initDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => reject(e.target.error);
      });
    };

    const deleteProjectFromDB = async (id) => {
      const db = await initDB();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
      });
    };

    // --- Printable Sheet Component ---
    const PrintableSheet = ({ title, instructor, deadline, comment, url, onClose }) => {
      const qrRef = useRef(null);

      useEffect(() => {
        if (qrRef.current) {
          qrRef.current.innerHTML = "";
          try {
            new QRCode(qrRef.current, { text: url, width: 140, height: 140 });
          } catch (e) {
            console.error("QRCode Error", e);
            qrRef.current.innerHTML = "QR Error";
          }
        }
      }, [url]);

      const renderAnswerColumns = () => {
        const columns = [[1, 10], [11, 20], [21, 30]];
        return (
          <div className="grid grid-cols-3 gap-6 mb-8 print:gap-4">
            {columns.map(([start, end], colIdx) => (
              <div key={colIdx} className="border border-gray-800 rounded-lg overflow-hidden print:border-gray-800">
                <div className="bg-gray-800 text-white p-1 text-center font-bold text-xs tracking-wider print:bg-gray-800 print:text-white">No. {start} - {end}</div>
                <div className="divide-y divide-gray-300 print:divide-gray-400">
                  {Array.from({ length: end - start + 1 }, (_, i) => start + i).map(num => (
                    <div key={num} className="flex h-8 bg-white print:h-9">
                      <div className="w-10 flex items-center justify-center font-bold text-xs border-r border-gray-300 print:border-gray-400 bg-gray-100 text-gray-700 print:bg-gray-100">{num}</div>
                      <div className="flex-1 border-r border-gray-300 print:border-gray-400 relative"></div>
                      <div className="w-10 relative flex items-center justify-center">
                        <div className="w-5 h-5 rounded-full border border-gray-300 print:border-gray-400"></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        );
      };

      return (
        <div className="fixed inset-0 bg-white z-[200] overflow-auto flex flex-col">
          {/* Print Toolbar - Hidden when printing */}
          <div className="bg-gray-800 text-white p-4 flex justify-between items-center print:hidden shrink-0">
            <h2 className="font-bold flex items-center gap-2"><Printer /> プレビュー</h2>
            <div className="flex gap-4">
              <button onClick={onClose} className="px-4 py-2 hover:bg-gray-700 rounded">キャンセル</button>
              <button onClick={() => window.print()} className="bg-blue-600 px-6 py-2 rounded font-bold hover:bg-blue-700 flex items-center gap-2">
                <Printer size={20} /> 印刷
              </button>
            </div>
          </div>

          {/* A4 Sheet */}
          <div className="flex-1 bg-gray-100 p-8 overflow-auto print:bg-white print:p-0 print:overflow-visible flex justify-center">
            <div id="printable-area" className="bg-white shadow-xl print:shadow-none p-[15mm] print:px-[20mm] print:pt-[20mm] print:pb-[25mm] w-[210mm] print:w-full min-h-[297mm] text-gray-900 relative flex flex-col">

              <div className="flex justify-between items-start border-b-2 border-gray-800 pb-4 mb-6">
                <div className="flex-1">
                  <h1 className="text-xl font-bold mb-2 break-words text-gray-800 mr-4">{title}</h1>
                  <h2 className="text-sm font-bold text-gray-500 uppercase tracking-widest">Listening Assignment</h2>
                </div>
                <div className="flex gap-6 text-sm shrink-0">
                  <div className="text-right">
                    <p className="font-bold text-gray-400 text-[10px] uppercase">Instructor</p>
                    <p className="font-bold text-lg min-w-[80px] border-b border-gray-300">{instructor ? (instructor.trim().endsWith('講師') ? instructor : instructor + ' 講師') : ''}</p>
                  </div>
                  <div className="text-right">
                    <p className="font-bold text-gray-400 text-[10px] uppercase">Deadline</p>
                    <p className="font-bold text-lg text-red-600 min-w-[80px] border-b border-gray-300">{deadline}</p>
                  </div>
                </div>
              </div>

              <div className="flex gap-6 mb-6">
                <div className="flex-1 border border-gray-300 rounded-lg p-3 bg-gray-50 print:bg-white flex flex-col">
                  <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Message</p>
                  <p className="text-sm whitespace-pre-wrap leading-relaxed flex-1">{comment}</p>
                </div>
                <div className="w-40 shrink-0 flex flex-col items-center justify-center border border-gray-200 rounded-lg p-2 gap-1">
                  <div ref={qrRef} className="bg-white mix-blend-multiply"></div>
                  <p className="text-[8px] text-center font-bold text-gray-500 tracking-wider">SCAN TO START</p>
                </div>
              </div>

              <h3 className="text-center font-bold text-sm mb-2 text-gray-800 bg-gray-100 rounded-full w-40 mx-auto py-1 uppercase tracking-widest print:bg-transparent print:border print:border-gray-800">Answer Sheet</h3>
              {renderAnswerColumns()}

              <div className="mt-auto pt-8 border-t-2 border-gray-800 border-dashed">
                <div className="flex justify-between items-end">
                  <div className="mb-2 text-xs text-gray-500 font-medium">
                    <p className="mb-1">● 答え合わせはアプリの最後で確認できます。</p>
                    <p>● 自己採点後、日付と点数を記入して提出してください。</p>
                  </div>
                  <div className="flex gap-8 border-2 border-gray-800 rounded-xl px-8 py-4 bg-white print:border-gray-800 shadow-sm print:shadow-none">
                    <div className="text-center group">
                      <p className="text-[10px] font-bold text-gray-400 uppercase print:text-gray-600 mb-2 tracking-widest">Date</p>
                      <div className="flex items-end gap-2 justify-center">
                        <div className="border-b border-gray-800 w-10 print:border-black h-6"></div>
                        <span className="text-lg text-gray-400">/</span>
                        <div className="border-b border-gray-800 w-10 print:border-black h-6"></div>
                      </div>
                    </div>
                    <div className="w-px bg-gray-200 h-10 self-center print:bg-gray-400 mx-2"></div>
                    <div className="text-center group">
                      <p className="text-[10px] font-bold text-gray-400 uppercase print:text-gray-600 mb-2 tracking-widest">Score</p>
                      <div className="flex items-end">
                        <div className="border-b-2 border-gray-900 w-20 text-center text-3xl font-bold leading-none print:border-black h-8"></div>
                        <span className="text-sm font-bold ml-2 text-gray-500 relative -bottom-1">/ 30</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div className="absolute bottom-2 right-4 text-[9px] text-gray-300 font-sans print:text-gray-400">
                Eiken Listening Support App
              </div>
            </div>
          </div>
        </div>
      );
    };

    const HomeworkModal = ({ config, setConfig, onClose, onPrint }) => (
      <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 space-y-4 animate-fadeIn">
          <h2 className="text-xl font-bold flex items-center gap-2"><Printer /> 課題プリント作成</h2>
          <p className="text-sm text-gray-500">生徒配布用のプリントを作成します。必要な情報を入力してください。</p>

          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">講師名</label>
            <input type="text" className="w-full border rounded p-2" placeholder="例: 山田先生" value={config.instructor} onChange={e => setConfig({ ...config, instructor: e.target.value })} />
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">提出期限</label>
            <input type="date" className="w-full border rounded p-2" value={config.deadline} onChange={e => setConfig({ ...config, deadline: e.target.value })} />
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">コメント / 学習のねらい</label>
            <textarea className="w-full border rounded p-2 h-24" placeholder="例: Part 1のNo.1-5を重点的に復習しましょう。" value={config.comment} onChange={e => setConfig({ ...config, comment: e.target.value })}></textarea>
          </div>

          <div className="flex justify-end gap-3 pt-4 border-t">
            <button onClick={onClose} className="px-4 py-2 hover:bg-gray-100 rounded">キャンセル</button>
            <button onClick={onPrint} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">プレビューを表示</button>
          </div>
        </div>
      </div>
    );

    const App = () => {
      const queryParams = new URLSearchParams(window.location.search);
      const isStudentQuery = queryParams.has('student');
      const projectIdQuery = queryParams.get('projectId');
      const isRestrictedMode = isStudentQuery && projectIdQuery; // Hide library nav if specified

      // --- State Management ---
      const [isStudentMode] = useState(isStudentQuery);
      const [mode, setMode] = useState('library'); // Init as library, check params in useEffect
      const [isLoading, setIsLoading] = useState(false);
      const [localProjects, setLocalProjects] = useState([]);
      const [remoteProjects, setRemoteProjects] = useState([]);

      // Current Project Metadata
      const [projectId, setProjectId] = useState(null);
      const [projectTitle, setProjectTitle] = useState("無題のプロジェクト");
      const [currentAudioConfig, setCurrentAudioConfig] = useState(null);

      // Pages & Audio
      const [pages, setPages] = useState([]);
      const [currentPageIndex, setCurrentPageIndex] = useState(0);
      const [audioSrc, setAudioSrc] = useState(null);
      const [audioFileName, setAudioFileName] = useState(null);

      // Markers
      const [markers, setMarkers] = useState([]);
      const [selectedMarkerId, setSelectedMarkerId] = useState(null);

      // Interaction
      const [interactionState, setInteractionState] = useState({
        type: null, markerId: null, startX: 0, startY: 0, initialData: null
      });
      const [isDraggingOver, setIsDraggingOver] = useState(false);

      // Print State
      const [showHomeworkModal, setShowHomeworkModal] = useState(false);
      const [printConfig, setPrintConfig] = useState({ instructor: '', deadline: '', comment: '' });
      const [targetPrintProject, setTargetPrintProject] = useState(null); // Store which project to print
      const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
      const [uiVisible, setUiVisible] = useState(true);
      const [isMobileLandscape, setIsMobileLandscape] = useState(false);

      // Detect mobile landscape for immersive mode
      useEffect(() => {
        const checkOrientation = () => {
          setIsMobileLandscape(window.matchMedia('(max-height: 600px) and (orientation: landscape)').matches);
        };
        checkOrientation();
        window.addEventListener('resize', checkOrientation);
        return () => window.removeEventListener('resize', checkOrientation);
      }, []);

      // Audio Playback
      const [isPlaying, setIsPlaying] = useState(false);
      const [playbackRate, setPlaybackRate] = useState(1.0);
      const [currentMarkerId, setCurrentMarkerId] = useState(null);
      const [currentTime, setCurrentTime] = useState(0);
      const [duration, setDuration] = useState(0);

      const audioRef = useRef(null);
      const imageContainerRef = useRef(null);
      const audioCache = useRef({});
      const pendingPlayMarker = useRef(null);
      const pendingFullPlay = useRef(false);

      // Swipe handling refs
      const touchStartX = useRef(null);
      const touchEndX = useRef(null);

      const handleTouchStart = (e) => {
        touchStartX.current = e.targetTouches[0].clientX;
        touchEndX.current = null;
      };

      const handleTouchMove = (e) => {
        touchEndX.current = e.targetTouches[0].clientX;
      };

      const handleTouchEnd = () => {
        if (!touchStartX.current || !touchEndX.current) return;
        const distance = touchStartX.current - touchEndX.current;
        const isLeftSwipe = distance > 50;
        const isRightSwipe = distance < -50;

        if (mode !== 'edit') {
          if (isLeftSwipe && currentPageIndex < pages.length - 1) {
            goToNextPage();
          }
          if (isRightSwipe && currentPageIndex > 0) {
            goToPrevPage();
          }
        }
      };

      // --- Initial Load Logic ---
      useEffect(() => {
        const init = async () => {
          await refreshLibrary();
          if (typeof SERVER_ASSETS !== 'undefined') {
            // If server assets exist, use them? (Not used in current flow but kept for compatibility)
          }
          await fetchRemoteCatalog();
        };
        init();
      }, []);

      // Auto-load project if params exist
      const hasAutoLoaded = useRef(false);
      useEffect(() => {
        if (!hasAutoLoaded.current && projectIdQuery && (localProjects.length > 0 || remoteProjects.length > 0)) {
          const pLocal = localProjects.find(p => p.id === projectIdQuery);
          const pRemote = remoteProjects.find(p => p.id === projectIdQuery);

          if (pLocal) {
            handleOpenProject(pLocal.id);
            hasAutoLoaded.current = true;
          } else if (pRemote) {
            importRemoteProject(pRemote);
            hasAutoLoaded.current = true;
          }
        }
      }, [localProjects, remoteProjects, projectIdQuery]);

      const fetchRemoteCatalog = async () => {
        try {
          const res = await fetch('./projects_catalog.json');
          if (res.ok) {
            const data = await res.json();
            setRemoteProjects(data);
          }
        } catch (e) { console.error("Catalog load failed", e); }
      };

      const importRemoteProject = async (pMeta) => {
        setIsLoading(true);
        try {
          // Build URL
          const jsonUrl = pMeta.dir ? `${pMeta.dir}/${pMeta.json}` : pMeta.json;

          const res = await fetch(jsonUrl);
          if (!res.ok) throw new Error(`Data not found (${res.status})`);

          const data = await res.json();

          // Check/Delete existing
          try { await deleteProjectFromDB(pMeta.id); } catch (e) { }

          const pagesForDB = data.pages ? await Promise.all(data.pages.map(async (p) => {
            const r = await fetch(p.src);
            const b = await r.blob();
            return { id: p.id, name: p.name, blob: b };
          })) : [];

          const projectData = {
            id: pMeta.id,
            title: pMeta.title,
            updatedAt: new Date().toISOString(),
            markers: data.markers || [],
            pages: pagesForDB,
            audio: null,
            audioConfig: {
              baseDir: pMeta.dir,
              tracks: pMeta.audio
            }
          };

          await saveProjectToDB(projectData);
          await refreshLibrary();

          handleOpenProject(pMeta.id);
          // if (isStudentMode) alert("教材を読み込みました。"); // Suppress alert for smooth entry
        } catch (err) {
          console.error("Project load failed", err);
          alert("読み込みに失敗しました。\n" + err.message);
        } finally {
          setIsLoading(false);
        }
      };

      const refreshLibrary = async () => {
        setIsLoading(true);
        try {
          const list = await getAllProjectsMeta();
          setLocalProjects(list);
        } catch (e) { console.error(e); }
        finally { setIsLoading(false); }
      };

      // Merge Local and Remote Projects
      const projectList = React.useMemo(() => {
        const locals = localProjects.map(p => ({ ...p, isLocal: true }));
        const remotes = remoteProjects
          .filter(r => !localProjects.find(l => l.id === r.id))
          .map(r => ({
            ...r,
            isRemote: true,
            isLocal: false,
            updatedAt: new Date().toISOString(),
            pagesCount: '-',
            hasAudio: r.audio && r.audio.length > 0
          }));
        return [...locals, ...remotes].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      }, [localProjects, remoteProjects]);

      // --- Helper: Blob/Url Handling ---
      const blobUrlToBlob = async (blobUrl) => {
        const response = await fetch(blobUrl);
        return await response.blob();
      };

      const blobUrlToBase64 = async (blobUrl) => {
        const blob = await blobUrlToBlob(blobUrl);
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      };

      const loadServerAudio = async (url, name) => {
        if (!url) return;
        if (audioSrc && !confirm("音声を切り替えますか？")) return;

        setIsLoading(true);
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("Fetch failed");
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          setAudioSrc(blobUrl);
          setAudioFileName(name);
          setCurrentTime(0);
          if (audioRef.current) {
            audioRef.current.currentTime = 0;
          }
        } catch (e) {
          console.error(e);
          alert("音声ファイルの読み込みに失敗しました。");
        } finally {
          setIsLoading(false);
        }
      };

      // --- Actions ---
      const startNewProject = () => {
        setProjectId(Date.now().toString()); // Temporary ID
        setProjectTitle("無題のプロジェクト");
        setPages([]);
        setMarkers([]);
        setAudioSrc(null);
        setAudioFileName(null);
        setCurrentAudioConfig(null);
        setCurrentPageIndex(0);
        setMode('edit');
      };

      const handleOpenProject = async (id) => {
        setIsLoading(true);
        try {
          const project = await getProjectFromDB(id);
          if (!project) throw new Error("Project not found");

          // Restore Pages (Blob -> Blob URL)
          const restoredPages = project.pages.map(p => ({
            ...p,
            src: URL.createObjectURL(p.blob)
          }));

          setProjectId(project.id);
          setProjectTitle(project.title);
          setPages(restoredPages);
          setMarkers(project.markers);
          setCurrentAudioConfig(project.audioConfig || null); // Restore Config

          // Restore Audio
          if (project.audio) {
            setAudioSrc(URL.createObjectURL(project.audio.blob));
            setAudioFileName(project.audio.name);
          } else {
            setAudioSrc(null);
            setAudioFileName(null);
          }

          setCurrentPageIndex(0);
          setMode(isStudentMode ? 'practice' : 'practice');
        } catch (e) {
          console.error("Failed to open project", e);
          alert("プロジェクトを開けませんでした。");
        } finally {
          setIsLoading(false);
        }
      };

      const handleDeleteProject = async (id, e) => {
        e.stopPropagation();
        if (!window.confirm("このプロジェクトを削除してもよろしいですか？\nこの操作は取り消せません。")) return;

        setIsLoading(true);
        try {
          await deleteProjectFromDB(id);
          await refreshLibrary();
        } catch (e) {
          console.error("Failed to delete", e);
          alert("削除に失敗しました。");
        } finally {
          setIsLoading(false);
        }
      };

      const handleSaveToDB = async () => {
        if (pages.length === 0 && !audioSrc) {
          alert("保存するデータがありません。");
          return;
        }

        const titleInput = prompt("プロジェクト名を入力してください", projectTitle);
        if (titleInput === null) return;
        const finalTitle = titleInput || "無題のプロジェクト";
        setProjectTitle(finalTitle);

        setIsLoading(true);
        try {
          const pagesForDB = await Promise.all(pages.map(async (p) => ({
            id: p.id,
            name: p.name,
            blob: await blobUrlToBlob(p.src)
          })));

          let audioForDB = null;
          if (audioSrc) {
            audioForDB = {
              name: audioFileName,
              blob: await blobUrlToBlob(audioSrc)
            };
          }

          const projectData = {
            id: projectId,
            title: finalTitle,
            updatedAt: new Date().toISOString(),
            markers,
            markers,
            pages: pagesForDB,
            audio: audioForDB,
            audioConfig: currentAudioConfig
          };

          await saveProjectToDB(projectData);
          alert("データベースに保存しました！");
          await refreshLibrary();
        } catch (e) {
          console.error("Save failed", e);
          alert("保存に失敗しました。");
        } finally {
          setIsLoading(false);
        }
      };

      // JSON Export (Backup)
      const handleExportJSON = async () => {
        if (pages.length === 0 && !audioSrc) return;
        setIsLoading(true);
        try {
          const serializedPages = await Promise.all(pages.map(async (p) => ({
            ...p,
            src: await blobUrlToBase64(p.src)
          })));

          let serializedAudio = null;
          if (audioSrc) {
            serializedAudio = {
              name: audioFileName,
              data: await blobUrlToBase64(audioSrc)
            };
          }

          const projectData = {
            version: "1.0",
            timestamp: new Date().toISOString(),
            title: projectTitle,
            markers,
            pages: serializedPages,
            audio: serializedAudio
          };

          const jsonString = JSON.stringify(projectData);
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${projectTitle.replace(/\s+/g, '_')}_Backup.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error(e);
          alert("エクスポート失敗");
        } finally {
          setIsLoading(false);
        }
      };

      // --- File Processing ---
      const processFiles = useCallback((files) => {
        const imageFiles = [];
        let audioFile = null;

        files.forEach(file => {
          if (file.type.startsWith('image/')) {
            imageFiles.push(file);
          } else if (file.type.startsWith('audio/')) {
            audioFile = file;
          } else if (file.name.endsWith('.json')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                alert("JSONファイルはライブラリ画面の「インポート」機能、または現在編集中なら読み込みボタンを使用してください。");
              } catch (err) { console.error(err); }
            };
            reader.readAsText(file);
          }
        });

        if (imageFiles.length > 0) {
          imageFiles.sort((a, b) => a.name.localeCompare(b.name));
          const newPages = imageFiles.map(file => ({
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            src: URL.createObjectURL(file),
            name: file.name || "Pasted Image"
          }));
          setPages(prev => [...prev, ...newPages]);
        }

        if (audioFile) {
          setAudioSrc(URL.createObjectURL(audioFile));
          setAudioFileName(audioFile.name);
        }
      }, []);

      // --- Interaction & Events ---
      const handleMarkerMouseDown = (e, marker, type) => {
        if (mode !== 'edit') return;
        e.stopPropagation();
        setInteractionState({
          type,
          markerId: marker.id,
          startX: e.clientX,
          startY: e.clientY,
          initialData: { x: marker.x, y: marker.y, width: marker.width, height: marker.height }
        });
      };

      // ... existing handlers ...

      // --- Render Helpers ---

      // ... existing play/audio logic ...

      // Update audio effect hooks...

      useEffect(() => {
        const handleMouseMove = (e) => {
          if (!interactionState.type || !imageContainerRef.current) return;
          const rect = imageContainerRef.current.getBoundingClientRect();
          const deltaX_px = e.clientX - interactionState.startX;
          const deltaY_px = e.clientY - interactionState.startY;
          const deltaX_pct = (deltaX_px / rect.width) * 100;
          const deltaY_pct = (deltaY_px / rect.height) * 100;

          setMarkers(prev => prev.map(m => {
            if (m.id !== interactionState.markerId) return m;
            if (interactionState.type === 'move') {
              return {
                ...m,
                x: interactionState.initialData.x + deltaX_pct,
                y: interactionState.initialData.y + deltaY_pct
              };
            } else if (interactionState.type === 'resize') {
              return {
                ...m,
                width: Math.max(2, interactionState.initialData.width + deltaX_pct),
                height: Math.max(2, interactionState.initialData.height + deltaY_pct)
              };
            }
            return m;
          }));
        };
        const handleMouseUp = () => {
          if (interactionState.type) {
            setInteractionState({ type: null, markerId: null, startX: 0, startY: 0, initialData: null });
          }
        };
        if (interactionState.type) {
          window.addEventListener('mousemove', handleMouseMove);
          window.addEventListener('mouseup', handleMouseUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        };
      }, [interactionState]);

      // --- Drag & Drop (Global) ---
      const dragCounter = useRef(0);
      useEffect(() => {
        const handleDragEnter = (e) => { e.preventDefault(); dragCounter.current++; if (dragCounter.current === 1) setIsDraggingOver(true); };
        const handleDragLeave = (e) => { e.preventDefault(); dragCounter.current--; if (dragCounter.current === 0) setIsDraggingOver(false); };
        const handleDragOver = (e) => { e.preventDefault(); };
        const handleDrop = (e) => {
          e.preventDefault();
          dragCounter.current = 0;
          setIsDraggingOver(false);
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) processFiles(Array.from(e.dataTransfer.files));
        };

        window.addEventListener('dragenter', handleDragEnter);
        window.addEventListener('dragleave', handleDragLeave);
        window.addEventListener('dragover', handleDragOver);
        window.addEventListener('drop', handleDrop);
        return () => {
          window.removeEventListener('dragenter', handleDragEnter);
          window.removeEventListener('dragleave', handleDragLeave);
          window.removeEventListener('dragover', handleDragOver);
          window.removeEventListener('drop', handleDrop);
        };
      }, [processFiles]);

      // --- Utilities ---
      const renumberMarkers = () => {
        if (!confirm('全ての問題番号をQ1から順に振り直しますか？\n(ページの順序、上から下の順序でラベル更新されます)')) return;
        setMarkers(prev => {
          const sorted = [...prev].sort((a, b) => {
            const pA = pages.findIndex(p => p.id === a.pageId);
            const pB = pages.findIndex(p => p.id === b.pageId);
            if (pA !== pB) return pA - pB;
            if (Math.abs(a.y - b.y) > 2) return a.y - b.y;
            return a.x - b.x;
          });
          return sorted.map((m, i) => ({ ...m, label: `No.${i + 1}` }));
        });
      };

      useEffect(() => {
        const handlePaste = (e) => {
          if (mode === 'library') return;
          if (e.clipboardData && e.clipboardData.items) {
            const items = e.clipboardData.items;
            const files = [];
            for (let i = 0; i < items.length; i++) {
              if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const file = new File([blob], `Pasted Image ${new Date().toLocaleTimeString()}`, { type: blob.type });
                files.push(file);
              }
            }
            if (files.length > 0) processFiles(files);
          }
        };
        window.addEventListener('paste', handlePaste);
        return () => window.removeEventListener('paste', handlePaste);
      }, [processFiles, mode]);

      // --- Navigation ---
      const goToNextPage = () => { if (currentPageIndex < pages.length - 1) setCurrentPageIndex(prev => prev + 1); };
      const goToPrevPage = () => { if (currentPageIndex > 0) setCurrentPageIndex(prev => prev - 1); };
      const deletePage = (index) => {
        const pageToDelete = pages[index];
        setMarkers(prev => prev.filter(m => m.pageId !== pageToDelete.id));
        const newPages = pages.filter((_, i) => i !== index);
        setPages(newPages);
        if (currentPageIndex >= newPages.length) setCurrentPageIndex(Math.max(0, newPages.length - 1));
      };

      // --- Marker Ops ---
      const addMarker = (e) => {
        if (mode !== 'edit' || !imageContainerRef.current || pages.length === 0) return;
        if (interactionState.type) return;
        const rect = imageContainerRef.current.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        const currentPage = pages[currentPageIndex];
        const newMarker = {
          id: Date.now(), x, y, width: 10, height: 5, startTime: 0, endTime: 10,
          label: `No.${markers.length + 1}`, pageId: currentPage.id
        };
        setMarkers([...markers, newMarker]);
        setSelectedMarkerId(newMarker.id);
      };
      const updateMarker = (id, field, value) => setMarkers(markers.map(m => m.id === id ? { ...m, [field]: value } : m));
      const deleteMarker = (id) => {
        setMarkers(markers.filter(m => m.id !== id));
        if (selectedMarkerId === id) setSelectedMarkerId(null);
      };



      // Heuristic to map Marker Label to Audio Part
      // Heuristic to map Marker Label to Audio Part
      const getAudioInfoForMarker = (marker) => {
        if (!marker || !marker.label || !currentAudioConfig) return null;

        const match = marker.label.match(/(\d+)/);
        if (!match) return null;
        const num = parseInt(match[1], 10);

        // Find track that covers this number
        const track = currentAudioConfig.tracks.find(t => num >= t.range[0] && num <= t.range[1]);
        if (!track) return null;

        return {
          url: `${currentAudioConfig.baseDir}/${track.file}`,
          name: track.label
        };
      };

      const loadAudioToCache = async (url) => {
        if (audioCache.current[url]) return audioCache.current[url];

        setIsLoading(true);
        try {
          const res = await fetch(url);
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          audioCache.current[url] = blobUrl;
          return blobUrl;
        } finally {
          setIsLoading(false);
        }
      };

      // --- Audio Ops ---
      const playSegment = async (marker) => {
        if (!audioRef.current) return;

        // 1. Page Navigation
        const targetPageIndex = pages.findIndex(p => p.id === marker.pageId);
        if (targetPageIndex !== -1 && targetPageIndex !== currentPageIndex) setCurrentPageIndex(targetPageIndex);

        // 2. Determine required audio
        const audioInfo = getAudioInfoForMarker(marker);
        let targetBlobUrl = audioSrc;
        let targetName = audioFileName;

        if (audioInfo) {
          // Ensure it is loaded
          if (!audioCache.current[audioInfo.url]) {
            targetBlobUrl = await loadAudioToCache(audioInfo.url);
          } else {
            targetBlobUrl = audioCache.current[audioInfo.url];
          }
          targetName = audioInfo.name;
        }

        // 3. Switch Audio if needed
        if (targetBlobUrl !== audioSrc) {
          setAudioSrc(targetBlobUrl);
          setAudioFileName(targetName);
          pendingPlayMarker.current = marker; // Queue play
          // The useEffect below will trigger play when src changes
        } else {
          // 4. Just Play
          audioRef.current.playbackRate = playbackRate;
          audioRef.current.pause();
          audioRef.current.currentTime = marker.startTime;
          setCurrentMarkerId(marker.id);
          audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
        }
      };

      // Auto-play after audio switch
      useEffect(() => {
        if (pendingPlayMarker.current && audioRef.current && audioSrc) {
          const marker = pendingPlayMarker.current;
          pendingPlayMarker.current = null;

          audioRef.current.playbackRate = playbackRate;
          audioRef.current.currentTime = marker.startTime;
          setCurrentMarkerId(marker.id);
          audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
        } else if (pendingFullPlay.current && audioRef.current && audioSrc) {
          pendingFullPlay.current = false;
          audioRef.current.playbackRate = playbackRate;
          audioRef.current.currentTime = 0;
          setCurrentMarkerId(null); // Disable marker stop
          audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
        }
      }, [audioSrc]);

      const playFullTrack = async (url, name) => {
        if (audioSrc && audioFileName === name) {
          if (audioRef.current) {
            audioRef.current.currentTime = 0;
            audioRef.current.play();
            setIsPlaying(true);
          }
          setCurrentMarkerId(null);
          return;
        }
        setIsLoading(true);
        try {
          const blobUrl = await loadAudioToCache(url);
          pendingFullPlay.current = true;
          setAudioSrc(blobUrl);
          setAudioFileName(name);
        } catch (e) { console.error(e); }
        finally { setIsLoading(false); }
      };

      // Auto-switch audio on page change
      useEffect(() => {
        if (mode !== 'practice' || pages.length === 0) return;

        const currentPage = pages[currentPageIndex];
        if (!currentPage) return;

        const pageMarkers = markers.filter(m => m.pageId === currentPage.id);
        if (pageMarkers.length === 0) return;

        // Use first marker to determine page's audio
        const info = getAudioInfoForMarker(pageMarkers[0]);
        // Only switch if different AND valid
        if (info && info.name !== audioFileName) {
          (async () => {
            try {
              const blobUrl = await loadAudioToCache(info.url);
              setAudioSrc(blobUrl);
              setAudioFileName(info.name);
              setIsPlaying(false);
              if (audioRef.current) {
                audioRef.current.pause();
                audioRef.current.currentTime = 0;
              }
            } catch (e) {
              console.error("Auto-switch failed", e);
            }
          })();
        }
      }, [currentPageIndex, mode]);

      const togglePlay = () => {
        if (!audioRef.current) return;
        audioRef.current.playbackRate = playbackRate;
        if (isPlaying) { audioRef.current.pause(); setIsPlaying(false); }
        else { audioRef.current.play(); setIsPlaying(true); }
      };
      const toggleSpeed = () => {
        const newRate = playbackRate === 1.0 ? 2.0 : 1.0;
        setPlaybackRate(newRate);
        if (audioRef.current) audioRef.current.playbackRate = newRate;
      };
      const seekRelative = (s) => {
        if (!audioRef.current) return;
        audioRef.current.currentTime = Math.min(Math.max(audioRef.current.currentTime + s, 0), duration);
        setCurrentTime(audioRef.current.currentTime);
      };
      useEffect(() => {
        const audio = audioRef.current;
        if (!audio) return;
        const handleTimeUpdate = () => {
          setCurrentTime(audio.currentTime);
          if (currentMarkerId && isPlaying) {
            const activeMarker = markers.find(m => m.id === currentMarkerId);
            if (activeMarker && audio.currentTime >= activeMarker.endTime) {
              audio.pause(); setIsPlaying(false); setCurrentMarkerId(null); audio.currentTime = activeMarker.startTime;
            }
          }
        };
        const handleLoadedMetadata = () => setDuration(audio.duration);
        audio.addEventListener('timeupdate', handleTimeUpdate);
        audio.addEventListener('loadedmetadata', handleLoadedMetadata);
        audio.playbackRate = playbackRate;
        return () => {
          audio.removeEventListener('timeupdate', handleTimeUpdate);
          audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
        };
      }, [currentMarkerId, isPlaying, markers, playbackRate]);

      const formatTime = (time) => {
        if (isNaN(time)) return "0:00";
        const m = Math.floor(time / 60);
        const s = Math.floor(time % 60);
        const ms = Math.floor((time % 1) * 10);
        return `${m}:${s.toString().padStart(2, '0')}.${ms}`;
      };

      const currentPage = pages[currentPageIndex];
      const currentMarkers = currentPage ? markers.filter(m => m.pageId === currentPage.id) : [];
      if (mode === 'library') {
        return (
          <div className="min-h-screen bg-gray-50 flex flex-col items-center p-8">
            {showHomeworkModal && (
              <HomeworkModal
                config={printConfig}
                setConfig={setPrintConfig}
                onClose={() => setShowHomeworkModal(false)}
                onPrint={() => { setShowHomeworkModal(false); setMode('print'); }}
              />
            )}
            <div className="w-full max-w-4xl space-y-8">
              <div className="flex items-center gap-3 mb-8">
                <div className="bg-blue-600 text-white p-3 rounded-xl shadow-lg">
                  <Database size={32} />
                </div>
                <div>
                  <h1 className="text-3xl font-bold text-gray-800">英検リスニング演習 Studio {isStudentMode && <span className="bg-green-100 text-green-700 text-sm px-2 py-1 rounded-full ml-2 align-middle">生徒モード</span>}</h1>
                  <p className="text-gray-500">ローカルデータベースモード</p>
                </div>
              </div>

              {/* Action Cards */}
              {!isStudentMode ? (
                <div className="grid md:grid-cols-2 gap-4">
                  <button
                    onClick={startNewProject}
                    className="bg-white p-6 rounded-xl shadow-sm border-2 border-dashed border-blue-200 hover:border-blue-400 hover:bg-blue-50 transition flex flex-col items-center justify-center gap-4 group h-48"
                  >
                    <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 group-hover:scale-110 transition">
                      <PlusCircle size={32} />
                    </div>
                    <div className="text-center">
                      <h3 className="font-bold text-lg text-blue-900">新規プロジェクト作成</h3>
                      <p className="text-sm text-gray-500">画像と音声から新しい演習を作成</p>
                    </div>
                  </button>

                  <div className="bg-white p-6 rounded-xl shadow-md border flex flex-col justify-between h-48">
                    <div>
                      <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><CheckCircle size={20} /> 生徒用リンク</h3>
                      <p className="text-gray-500 text-sm mt-2">
                        トップ画面（プロジェクト一覧）の共有URLです。特定の課題を指定する場合は、下のリストから「課題作成」を行ってください。
                      </p>
                    </div>
                    <button onClick={() => {
                      const url = new URL(window.location.href);
                      url.searchParams.set('student', 'true');
                      url.searchParams.delete('projectId'); // Generic link
                      navigator.clipboard.writeText(url.toString());
                      alert("生徒用リンク（トップページ）をコピーしました！\n" + url.toString());
                    }} className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                      トップページURLをコピー
                    </button>
                  </div>
                </div>
              ) : (
                /* Student Mode Actions */
                <div className="bg-green-50 border border-green-200 p-6 rounded-xl text-green-800">
                  <h3 className="font-bold flex items-center gap-2"><CheckCircle size={20} /> 学習を開始しましょう</h3>
                  <p className="text-sm mt-1 mb-4">以下のリストからプロジェクトを選んでください。</p>
                  <button onClick={() => fetchRemoteCatalog()} className="text-xs bg-white hover:bg-green-100 text-green-700 px-3 py-1.5 rounded transition border border-green-300">
                    ↻ カタログ更新
                  </button>
                </div>
              )}

              {/* Project List */}
              <div className="space-y-4">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <Clock size={20} /> 学習プロジェクト
                </h2>

                {isLoading ? (
                  <div className="text-center py-12 text-gray-400 animate-pulse">読み込み中...</div>
                ) : projectList.length > 0 ? (
                  <div className="space-y-10">
                    {(() => {
                      const categories = [
                        { id: 'l5', label: '英検5級', match: (s) => /level5|Grade\s*5/i.test(s) },
                        { id: 'l4', label: '英検4級', match: (s) => /level4|Grade\s*4/i.test(s) },
                        { id: 'l3', label: '英検3級', match: (s) => /level3|Grade\s*3/i.test(s) },
                        { id: 'lp2', label: '英検準2級', match: (s) => /levelpre2(?!plus)|Grade\s*Pre-?2(?!.*Plus)/i.test(s) },
                        { id: 'lp2p', label: '英検準2級プラス', match: (s) => /levelpre2plus|Grade\s*Pre-?2\s*Plus/i.test(s) },
                        { id: 'l2', label: '英検2級', match: (s) => /(level2|Grade\s*2)(?!.*Pre)/i.test(s) },
                        { id: 'lp1', label: '英検準1級', match: (s) => /levelpre1|Grade\s*Pre-?1/i.test(s) },
                      ];

                      const groups = {};
                      const others = [];
                      categories.forEach(c => groups[c.id] = []);

                      projectList.forEach(p => {
                        const s = (p.id + " " + p.title).toLowerCase();
                        const cat = categories.find(c => c.match(s));
                        if (cat) groups[cat.id].push(p);
                        else others.push(p);
                      });

                      return [...categories, { id: 'other', label: 'その他' }].map(cat => {
                        const list = cat.id === 'other' ? others : groups[cat.id];
                        if (!list || list.length === 0) return null;
                        return (
                          <div key={cat.id}>
                            <h3 className="font-bold text-gray-500 text-sm mb-3 pl-3 border-l-4 border-blue-500 flex items-center gap-2">
                              {cat.label}
                              <span className="bg-gray-100 text-gray-500 text-[10px] px-2 py-0.5 rounded-full">{list.length}</span>
                            </h3>
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 divide-y">
                              {list.map(project => (
                                <div key={project.id} onClick={() => project.isLocal ? handleOpenProject(project.id) : importRemoteProject(project)}
                                  className="p-4 flex items-center justify-between hover:bg-gray-50 cursor-pointer transition group">
                                  <div className="flex items-center gap-4">
                                    {!isStudentMode && (
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          setTargetPrintProject(project);
                                          setProjectTitle(project.title);
                                          setProjectId(project.id);
                                          setShowHomeworkModal(true);
                                        }}
                                        className="p-3 text-gray-400 hover:text-blue-600 hover:bg-blue-100 rounded-full transition border border-transparent hover:border-blue-200"
                                        title="課題プリント作成"
                                      >
                                        <Printer size={20} />
                                      </button>
                                    )}
                                    <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">
                                      <FileText size={24} />
                                    </div>
                                    <div>
                                      <h3 className="font-bold text-gray-800 group-hover:text-blue-600 transition">
                                        {project.title
                                          .replace(/(\d{4})\s+Session\s+(\d+)/i, '$1年度 第$2回')
                                          .replace(/Eiken\s+Grade\s+Pre-?2\s+Plus/i, '英検準2級プラス')
                                          .replace(/Eiken\s+Grade\s+Pre-?2/i, '英検準2級')
                                          .replace(/Eiken\s+Grade\s+Pre-?1/i, '英検準1級')
                                          .replace(/Eiken\s+Grade\s+(\d+)/i, '英検$1級')}
                                      </h3>
                                      <div className="flex items-center gap-4 text-xs text-gray-500 mt-1">
                                        <span className="flex items-center gap-1"><Layers size={12} /> {project.pagesCount} ページ</span>
                                        <span className="flex items-center gap-1"><Volume2 size={12} /> {project.hasAudio ? '音声あり' : '音声なし'}</span>
                                        <span>更新: {new Date(project.updatedAt).toLocaleString()}</span>
                                      </div>
                                    </div>
                                  </div>
                                  {!isStudentMode && (
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={(e) => handleDeleteProject(project.id, e)}
                                        className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition"
                                        title="削除"
                                      >
                                        <Trash2 size={20} />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      });
                    })()}
                  </div>
                ) : (
                  <div className="text-center py-12 bg-white rounded-xl border border-gray-200 text-gray-400">
                    まだプロジェクトがありません
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      if (mode === 'print') {
        const url = new URL(window.location.href);
        url.searchParams.set('student', 'true');
        if (projectId) {
          url.searchParams.set('projectId', projectId);
        }
        return <PrintableSheet
          title={projectTitle}
          instructor={printConfig.instructor}
          deadline={printConfig.deadline}
          comment={printConfig.comment}
          url={url.toString()}
          onClose={() => setMode('library')}
        />;
      }

      // --- RENDER: EDITOR / PRACTICE MODE ---
      return (
        <div className="flex flex-col h-[100dvh] bg-gray-50 text-gray-800 font-sans">
          {showHomeworkModal && (
            <HomeworkModal
              config={printConfig}
              setConfig={setPrintConfig}
              onClose={() => setShowHomeworkModal(false)}
              onPrint={() => { setShowHomeworkModal(false); setMode('print'); }}
            />
          )}
          {isLoading && <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center text-white"><div className="text-xl font-bold animate-pulse">処理中...</div></div>}
          {isDraggingOver && <div className="fixed inset-0 bg-blue-500/90 z-50 flex items-center justify-center text-white backdrop-blur-sm"><div className="text-center p-8 border-4 border-dashed border-white/50 rounded-xl"><Upload size={64} className="mx-auto mb-4" /><h2 className="text-3xl font-bold">ファイルをドロップ</h2><p className="mt-2 text-blue-100">画像・音声を追加</p></div></div>}

          {/* Header */}
          <header className={`bg-blue-600 text-white p-2 md:p-3 shadow-md flex justify-between items-center z-50 shrink-0 transition-transform duration-300 ${isMobileLandscape ? 'fixed top-0 w-full' : 'relative'} ${isMobileLandscape && !uiVisible ? '-translate-y-full' : 'translate-y-0'}`}>
            <div className="flex items-center gap-2 min-w-0 flex-1 lg:flex-none">
              <button onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)} className="lg:hidden p-2 text-blue-100 hover:text-white rounded-lg -ml-1 shrink-0">
                {isMobileSidebarOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
              {!isRestrictedMode && (
                <button onClick={() => setMode('library')} className="hover:bg-blue-700 p-2 rounded-lg transition shrink-0" title="ライブラリに戻る">
                  <ArrowLeft size={24} />
                </button>
              )}
              <div className="flex items-center gap-1 overflow-hidden min-w-0">
                <Volume2 className="w-5 h-5 shrink-0" />
                {mode === 'edit' ? (
                  <input
                    type="text"
                    value={projectTitle}
                    onChange={(e) => setProjectTitle(e.target.value)}
                    className="bg-blue-700 text-white font-bold px-2 py-1 rounded border border-blue-500 hover:border-blue-300 focus:outline-none focus:border-white transition min-w-[50px] w-full"
                    placeholder="プロジェクト名"
                  />
                ) : (
                  <h1 className="text-sm sm:text-lg font-bold truncate">{projectTitle}</h1>
                )}
              </div>
            </div>
            {pages.length > 0 && (
              <div className="flex items-center gap-1 md:gap-4 bg-white/10 px-2 md:px-4 py-1 md:py-2 rounded-lg md:rounded-xl mx-1 md:mx-4 border border-white/20 shadow-sm backdrop-blur-sm">
                <button onClick={goToPrevPage} disabled={currentPageIndex === 0} className="p-1 md:p-2 bg-white/20 hover:bg-white/30 rounded-lg disabled:opacity-30 transition hover:scale-105 active:scale-95 shadow-sm" title="前のページ"><ChevronLeft size={24} strokeWidth={3} /></button>
                <span className="text-sm md:text-xl font-bold font-mono min-w-[40px] md:min-w-[100px] text-center text-white drop-shadow-md tracking-wider"><span className="hidden sm:inline">Page</span> {currentPageIndex + 1} <span className="text-[10px] md:text-sm opacity-70">/ {pages.length}</span></span>
                <button onClick={goToNextPage} disabled={currentPageIndex === pages.length - 1} className="p-1 md:p-2 bg-white/20 hover:bg-white/30 rounded-lg disabled:opacity-30 transition hover:scale-105 active:scale-95 shadow-sm" title="次のページ"><ChevronRight size={24} strokeWidth={3} /></button>
              </div>
            )}
            <div className="flex items-center gap-1 shrink-0">
              {!isStudentMode && (
                <div className="flex bg-blue-700 rounded-lg p-1 mr-1">
                  <button onClick={handleExportJSON} className="p-1.5 text-blue-100 hover:text-white hover:bg-blue-600 rounded" title="バックアップ(JSON)"><Download size={18} /></button>
                  <button onClick={handleSaveToDB} className="p-1.5 text-blue-100 hover:text-white hover:bg-blue-600 rounded flex items-center gap-1 px-2" title="DB保存"><Save size={18} /><span className="text-xs font-bold hidden sm:inline">保存</span></button>
                </div>
              )}
              {!isStudentMode && (
                <div className="flex bg-blue-700 rounded-lg p-1">
                  <button onClick={() => setMode('edit')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${mode === 'edit' ? 'bg-white text-blue-700 shadow' : 'text-blue-100 hover:text-white'}`}>編集</button>
                  <button onClick={() => { setSelectedMarkerId(null); setMode('practice'); }} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${mode === 'practice' ? 'bg-white text-blue-700 shadow' : 'text-blue-100 hover:text-white'}`}>演習</button>
                </div>
              )}
            </div>
          </header>

          <div className="flex-1 flex overflow-hidden">
            <div className="flex-1 bg-gray-200 overflow-auto relative">
              <div className="min-h-full p-4 sm:p-8 flex justify-center items-start">
                {currentPage ? (
                  <div
                    className="relative shadow-xl bg-white select-none transition-all duration-300 touch-pan-y"
                    style={{ maxWidth: '100%', width: 'fit-content' }}
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                  >
                    <img ref={imageContainerRef} src={currentPage.src} alt={`Page ${currentPageIndex + 1}`} className="max-w-full h-auto block cursor-crosshair" onClick={(e) => { if (mode === 'edit') addMarker(e); else setUiVisible(!uiVisible); }} draggable={false} />
                    {currentMarkers.map((marker) => {
                      // Render-time label formatting (Q1 -> No.1)
                      const displayLabel = marker.label.replace(/^Q(\d+)/, 'No.$1');

                      return (
                        <div key={marker.id}
                          onMouseDown={(e) => handleMarkerMouseDown(e, marker, 'move')}
                          onClick={(e) => { e.stopPropagation(); if (mode === 'practice') playSegment(marker); else setSelectedMarkerId(marker.id); }}
                          className={`absolute flex items-center justify-center transition-all ${mode === 'edit'
                            ? (selectedMarkerId === marker.id ? 'border-2 border-blue-500 bg-blue-500/20 z-20 cursor-move' : 'border-2 border-blue-300 bg-blue-300/10 hover:bg-blue-300/20 z-10 cursor-pointer')
                            : 'z-10 cursor-pointer hover:scale-110'}`} // Practice mode: minimal layout container
                          style={{
                            left: `${marker.x}%`, top: `${marker.y}%`,
                            width: `${marker.width || 10}%`, height: `${marker.height || 5}%`,
                            // Practice mode: remove border/bg from container, focus on the inner button
                            borderWidth: mode === 'practice' ? '0' : undefined,
                            backgroundColor: mode === 'practice' ? 'transparent' : undefined
                          }}>

                          {/* Inner Content */}
                          {mode === 'practice' ? (
                            <div className={`flex items-center gap-1 bg-white/95 backdrop-blur shadow-sm rounded-full px-1.5 py-0.5 border border-green-500 text-green-700 transition-colors hover:bg-green-500 hover:text-white group`}>
                              <Play size={10} fill="currentColor" strokeWidth={0} className="filter drop-shadow-sm" />
                              <span className="font-bold text-[10px] tracking-tight">{displayLabel}</span>
                            </div>
                          ) : (
                            // Edit Mode Label
                            <>
                              <span className={`text-xs font-bold px-1 rounded ${selectedMarkerId === marker.id ? 'bg-blue-600 text-white' : 'bg-white/80 text-gray-700'}`}>{displayLabel}</span>
                              {selectedMarkerId === marker.id && (
                                <div onMouseDown={(e) => handleMarkerMouseDown(e, marker, 'resize')} className="absolute bottom-0 right-0 w-4 h-4 bg-blue-500 cursor-nwse-resize z-30 flex items-center justify-center" style={{ transform: 'translate(50%, 50%)' }}>
                                  <Maximize2 size={8} className="text-white transform rotate-90" />
                                </div>
                              )}
                            </>
                          )}
                        </div>
                      );
                    })}
                    <div className="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm pointer-events-none">Page {currentPageIndex + 1}</div>
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center text-gray-400 space-y-4 max-w-md text-center my-auto h-[80vh]">
                    <div className="p-6 border-2 border-dashed border-gray-300 rounded-xl bg-gray-100">
                      <Upload size={48} className="mx-auto mb-2 text-gray-400" />
                      <p className="text-lg font-bold text-gray-600">ファイルをドロップ</p>
                      <p className="text-sm">画像・音声をドラッグ＆ドロップ</p>
                      <p className="text-xs text-blue-500 mt-2 font-semibold">Tip: スクショ(Ctrl+V)も使えます</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {isMobileSidebarOpen && (
              <div className="fixed inset-0 bg-black/50 z-30 lg:hidden animate-fadeIn" onClick={() => setIsMobileSidebarOpen(false)} />
            )}

            <div className={`w-80 bg-white border-l border-gray-200 flex flex-col shadow-xl z-40 shrink-0
              fixed inset-y-0 right-0 h-full transition-transform duration-300 ease-in-out
              lg:relative lg:translate-x-0 lg:h-auto lg:shadow-none
              ${isMobileSidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}>
              <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                {mode === 'edit' && (
                  <div className="space-y-6">
                    <div className="space-y-2">
                      <h3 className="font-bold text-gray-800 text-sm flex items-center gap-2"><Layers size={16} /> ページ管理</h3>
                      {pages.length > 0 ? (
                        <div className="bg-gray-50 border rounded-lg overflow-hidden">
                          {pages.map((page, idx) => (
                            <div key={page.id} onClick={() => setCurrentPageIndex(idx)} className={`flex items-center gap-2 p-2 cursor-pointer border-b last:border-0 hover:bg-gray-100 ${idx === currentPageIndex ? 'bg-blue-50 text-blue-700' : 'text-gray-600'}`}>
                              <div className="w-5 text-xs text-center font-bold text-gray-400">{idx + 1}</div>
                              <FileText size={14} />
                              <span className="text-xs truncate flex-1">{page.name}</span>
                              <button onClick={(e) => { e.stopPropagation(); deletePage(idx); }} className="text-gray-400 hover:text-red-500 p-1"><X size={14} /></button>
                            </div>
                          ))}
                        </div>
                      ) : <div className="text-xs text-gray-500 italic p-2 border border-dashed rounded text-center">画像を追加してください</div>}
                    </div>
                    <div>
                      <div className="flex justify-between items-center border-b pb-1 mb-2">
                        <h3 className="font-bold text-gray-800 text-sm">マーカー設定</h3>
                        <button onClick={renumberMarkers} className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-0.5 rounded border border-gray-300 transition">連番リネーム</button>
                      </div>
                      {pages.length === 0 ? <p className="text-xs text-gray-400">まずページを追加</p> : selectedMarkerId ? (
                        (() => {
                          const m = markers.find(mark => mark.id === selectedMarkerId);
                          if (!m) return null;
                          return (
                            <div className="bg-white border border-gray-200 rounded-lg p-3 shadow-sm space-y-3 animate-fadeIn">
                              <div className="flex justify-between items-center"><span className="font-bold text-blue-600 text-sm">編集中のマーカー</span><button onClick={() => deleteMarker(m.id)} className="text-red-500 hover:text-red-700 p-1"><Trash2 size={16} /></button></div>
                              <div className="space-y-2"><label className="text-xs text-gray-500 block">ラベル</label><input type="text" value={m.label} onChange={(e) => updateMarker(m.id, 'label', e.target.value)} className="w-full border rounded px-2 py-1 text-sm" /></div>
                              <div className="grid grid-cols-2 gap-2">
                                <div><label className="text-xs text-gray-500 block">開始</label><input type="number" step="0.1" value={m.startTime} onChange={(e) => updateMarker(m.id, 'startTime', parseFloat(e.target.value))} className="w-full border rounded px-2 py-1 text-sm font-mono" /><button onClick={() => audioRef.current && updateMarker(m.id, 'startTime', audioRef.current.currentTime)} className="mt-1 text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 w-full py-1 rounded">現在位置</button></div>
                                <div><label className="text-xs text-gray-500 block">終了</label><input type="number" step="0.1" value={m.endTime} onChange={(e) => updateMarker(m.id, 'endTime', parseFloat(e.target.value))} className="w-full border rounded px-2 py-1 text-sm font-mono" /><button onClick={() => audioRef.current && updateMarker(m.id, 'endTime', audioRef.current.currentTime)} className="mt-1 text-xs bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 w-full py-1 rounded">現在位置</button></div>
                              </div>
                              <button onClick={() => playSegment(m)} className="w-full mt-4 bg-green-600 text-white border-2 border-green-700 py-3 rounded-xl shadow-[0_4px_0_rgb(21,128,61)] hover:shadow-[0_2px_0_rgb(21,128,61)] hover:translate-y-[2px] transition-all flex items-center justify-center gap-3 active:shadow-none active:translate-y-[4px]"><Play size={28} fill="currentColor" strokeWidth={0} /> <span className="text-lg font-bold">テスト再生</span></button>
                            </div>
                          )
                        })()
                      ) : <div className="text-center py-6 text-gray-400 bg-gray-50 rounded border border-dashed"><PlusCircle className="mx-auto mb-2 opacity-50" /><p className="text-xs">画像をクリックして<br />問題を追加</p></div>}
                    </div>
                  </div>
                )}
                {mode === 'practice' && (
                  <div className="space-y-4">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800"><h3 className="font-bold flex items-center gap-2 mb-1 text-sm"><CheckCircle size={16} /> 演習モード</h3></div>
                    {/* Full Track Playback */}
                    {currentAudioConfig && currentAudioConfig.tracks.length > 0 && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <h3 className="font-bold flex items-center gap-2 mb-2 text-sm text-blue-800"><Volume2 size={16} /> パート別 通し再生</h3>
                        <p className="text-xs text-blue-600 mb-2">試験と同じ時間で各パートを通しで演習します。</p>
                        <div className="grid grid-cols-1 gap-2">
                          {currentAudioConfig.tracks.map((track, idx) => (
                            <button
                              key={idx}
                              onClick={() => playFullTrack(`${currentAudioConfig.baseDir}/${track.file}`, track.label)}
                              className="text-xs bg-white hover:bg-blue-600 hover:text-white text-blue-700 border border-blue-300 py-2 rounded flex items-center justify-center gap-2 transition font-bold"
                            >
                              <Play size={14} /> {track.label} (通し)
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                    <div className="bg-white border rounded-lg overflow-hidden">
                      <div className="bg-gray-100 px-3 py-2 border-b text-xs font-bold text-gray-500 flex justify-between items-center"><span>問題リスト</span><span className="font-normal text-gray-400">{markers.length}問</span></div>
                      <div className="max-h-[60vh] overflow-y-auto">
                        {pages.map((page, pIdx) => {
                          const pageMarkers = markers.filter(m => m.pageId === page.id).sort((a, b) => a.id - b.id);
                          if (pageMarkers.length === 0) return null;
                          return (
                            <div key={page.id}>
                              <div className="bg-gray-50 px-4 py-1 text-xs font-bold text-gray-400 uppercase tracking-wider border-b border-t border-gray-100 sticky top-0">Page {pIdx + 1}</div>
                              {pageMarkers.map(m => (
                                <button key={m.id} onClick={() => playSegment(m)} className={`w-full text-left px-4 py-3 border-b last:border-0 flex items-center gap-3 hover:bg-gray-50 transition group ${currentMarkerId === m.id ? 'bg-green-50 text-green-800 font-bold border-l-4 border-l-green-500' : 'text-gray-700 border-l-4 border-l-transparent'}`}>
                                  <div className={`p-2 rounded-full flex-shrink-0 transition-colors ${currentMarkerId === m.id ? 'bg-green-200 text-green-700' : 'bg-gray-100 text-gray-400 group-hover:bg-green-100 group-hover:text-green-600'}`}>
                                    <Play size={20} fill="currentColor" strokeWidth={0} />
                                  </div>
                                  <div className="flex-1 flex justify-between items-center min-w-0">
                                    <span className="text-base truncate">{m.label}</span>
                                    <span className="text-xs text-gray-400 font-mono flex-shrink-0 ml-2">{formatTime(m.startTime)}</span>
                                  </div>
                                </button>
                              ))}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div className={`bg-white border-t border-gray-200 p-4 z-30 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transition-transform duration-300 ${isMobileLandscape ? 'fixed bottom-0 w-full' : 'relative'} ${isMobileLandscape && !uiVisible ? 'translate-y-full' : 'translate-y-0'}`}>
            <div className="max-w-screen-2xl mx-auto space-y-2">
              <div className="relative group w-full"><input type="range" min={0} max={duration || 100} step="0.1" value={currentTime} onChange={(e) => { const time = parseFloat(e.target.value); if (audioRef.current) audioRef.current.currentTime = time; setCurrentTime(time); }} disabled={!audioSrc} className="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:h-5 transition-all disabled:opacity-50" /></div>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <button onClick={() => seekRelative(-5)} disabled={!audioSrc} className="w-8 h-8 rounded-full bg-gray-200 text-gray-700 flex items-center justify-center hover:bg-gray-300 transition shadow-sm disabled:opacity-50" title="5秒戻る"><RotateCcw size={16} /></button>
                  <button onClick={togglePlay} disabled={!audioSrc} className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 transition shadow-sm disabled:bg-gray-400">{isPlaying ? <Pause size={20} /> : <Play size={20} />}</button>
                  <button onClick={() => seekRelative(5)} disabled={!audioSrc} className="w-8 h-8 rounded-full bg-gray-200 text-gray-700 flex items-center justify-center hover:bg-gray-300 transition shadow-sm disabled:opacity-50" title="5秒進む"><RotateCw size={16} /></button>
                  <button onClick={toggleSpeed} disabled={!audioSrc} className="h-8 px-2 rounded-lg bg-gray-100 border border-gray-300 text-gray-700 flex items-center justify-center gap-1 hover:bg-gray-200 transition text-xs font-bold disabled:opacity-50" title="再生速度切替"><Gauge size={14} />{playbackRate.toFixed(1)}x</button>
                  <div className="flex flex-col justify-center h-10 border-l pl-4 ml-2">
                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider leading-none">Audio</span>
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-medium text-gray-700 truncate max-w-[150px] sm:max-w-xs leading-tight" title={audioFileName}>{audioFileName || "音声未選択"}</span>
                      <select
                        onChange={(e) => {
                          const val = e.target.value;
                          if (!val) return;
                          if (currentAudioConfig) {
                            const track = currentAudioConfig.tracks.find(t => `${currentAudioConfig.baseDir}/${t.file}` === val);
                            if (track) loadServerAudio(val, track.label);
                          }
                          e.target.value = "";
                        }}
                        className="text-xs border rounded bg-gray-50 max-w-[80px] opacity-70 hover:opacity-100 transition"
                      >
                        <option value="">Load...</option>
                        {currentAudioConfig && currentAudioConfig.tracks.map(t => (
                          <option key={t.file} value={`${currentAudioConfig.baseDir}/${t.file}`}>{t.label}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                </div>
                <div className="text-xl font-mono text-gray-700 font-bold">{formatTime(currentTime)} <span className="text-sm text-gray-400 font-normal">/ {formatTime(duration)}</span></div>
              </div>
            </div>
            <audio ref={audioRef} src={audioSrc} />
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>